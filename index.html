<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planetaire - HYBRID MASTER 51</title>
  <meta name="description" content="Programme sportif HYBRID MASTER 51, 26 semaines, 3 séances par semaine, analyse et heatmap interactive." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <main class="container">
    <header class="header row" role="banner">
      <div class="logo" aria-label="Logo programme">🏆</div>
      <div>
        <h1 class="title" id="mainTitle">HYBRID MASTER 51 — Ultimate V6</h1>
        <p class="small">26 semaines · 3 séances / semaine · Analyse & Heatmap</p>
      </div>
      <button class="btn ios" onclick="openDayExerciseManager()" aria-label="Gérer les exercices">🧩 Gérer les exercices</button>
    </header>
    <section class="programs" aria-label="Programme sportif">
      <section class="left">
        <div class="week-card card row">
          <div>
            <strong>Semaine <span id="weekDisplay">1</span></strong>
            <span class="small" id="blockName">Bloc</span>
          </div>
          <nav class="row" aria-label="Navigation des semaines">
            <button id="prevWeek" class="btn ios" aria-label="Semaine précédente">← Préc.</button>
            <button id="nextWeek" class="btn ios primary" aria-label="Semaine suivante">Suiv. →</button>
          </nav>
        </div>
        <div class="view-toggle-container">
          <button id="viewToggle" class="btn ios" aria-label="Changer la vue">🌀 Vue Exercices</button>
        </div>
        <section class="card" style="margin-top:12px">
          <div class="row" style="justify-content:space-between;align-items:center">
            <strong>Séances disponibles</strong>
            <span class="small">Tap pour ouvrir</span>
          </div>
          <div class="session-list" id="progList" style="margin-top:12px"></div>
        </section>
        <section class="exercise-list" id="exerciseArea" style="margin-top:14px"></section>
      </section>
      <aside class="right" aria-label="Tableau de bord et heatmap">
        <section class="card" aria-label="Tableau de bord">
          <strong>Tableau de bord</strong>
          <span class="small" id="quickMsg" style="margin-top:8px">Prêt.</span>
          <div class="dashboard-actions" style="margin-top:12px;">
            <button id="openStats" class="btn ios">📊 Statistiques</button>
            <button id="openStatsHist" class="btn ios">📈 Progression</button>
            <button id="openVolume" class="btn ios">📈 Volume</button>
            <button id="openMuscle" class="btn ios">💪 Muscles</button>
            <button id="exportCSV" class="btn ios">💾 Export</button>
            <button id="backupBtn" class="btn ios">☁️ Backup</button>
            <button id="resetApp" class="btn ios" style="color:var(--danger)">⚠️ Reset</button>
          </div>
        </section>
        <section class="card" style="margin-top:12px" aria-label="Heatmap de charge">
          <strong>Heatmap de charge (semaine)</strong>
          <div id="heatmapContainer">
            <div id="heatmap" class="heatmap" aria-hidden="false"></div>
            <div class="heat-legend">
              <span class="legend-pill c1" style="background:rgba(255,120,0,0.06)">Faible</span>
              <span class="legend-pill c2" style="background:rgba(255,120,0,0.12)">Moyen</span>
              <span class="legend-pill c3" style="background:rgba(255,120,0,0.22)">Haut</span>
              <span class="legend-pill c4" style="background:rgba(255,120,0,0.34)">Max</span>
            </div>
          </div>
        </section>
        <section class="card" style="margin-top:12px" aria-label="Gestion des exercices">
          <strong>Gestion des Exercices</strong>
          <span class="small" style="margin-top:8px" id="customCount">0 personnalisés</span>
          <div style="margin-top:8px">
            <button id="addCustom" class="btn ios">➕ Ajouter exercice</button>
            <button id="addIndependent" class="btn ios">🌟 Créer exercice indépendant</button>
            <button id="viewCustom" class="btn ios">👁 Voir</button>
            <button id="manageSessionExercises" class="btn ios">📅 Gérer séances</button>
          </div>
        </section>
      </aside>
    </section>
    <section id="heatmapPremium" class="card" aria-label="Heatmap Premium">
      <div class="title">Heatmap • Charge d'entraînement (4 semaines)</div>
      <div class="hm-header">
        <nav class="weekNav" aria-label="Navigation heatmap">
          <button id="hmPrev" aria-label="Heatmap précédente">‹</button>
          <span class="legendPill" id="hmRangeLabel">Semaine actuelle</span>
          <button id="hmNext" aria-label="Heatmap suivante">›</button>
        </nav>
        <div style="display:flex;gap:6px;align-items:center;">
          <span class="legendPill">Volume</span>
          <span class="legendPill">Séries</span>
        </div>
      </div>
      <div id="heatmapGrid" style="margin-top:14px;"></div>
      <div class="hm-legend" style="margin-top:12px;display:flex;justify-content:center;gap:6px;flex-wrap:wrap;">
        <span class="legendPill">Échelle</span>
        <span class="legendPill" style="background:#1e293b;">Faible</span>
        <span class="legendPill" style="background:#2563eb;">Moyen</span>
        <span class="legendPill" style="background:#f59e0b;color:#000;">Haut</span>
        <span class="legendPill" style="background:#ef4444;color:#000;">Max</span>
      </div>
    </section>
    <footer class="footer" role="contentinfo">© 2025 — HYBRID MASTER 51 — Ultimate V6</footer>
  </main>
  <div id="restTimer" class="rest-timer" style="display:none">
    <div class="timer-circle" aria-label="Minuteur repos">
      <svg width="72" height="72" viewBox="0 0 80 80">
        <circle cx="40" cy="40" r="34" stroke="rgba(255,255,255,0.06)" stroke-width="6" fill="none"/>
        <circle id="timerProgress" cx="40" cy="40" r="34" stroke="url(#g1)" stroke-width="6" fill="none" stroke-linecap="round" style="stroke-dasharray:214;stroke-dashoffset:214;transform:rotate(-90deg);transform-origin:50% 50%"></circle>
        <defs><linearGradient id="g1"><stop offset="0" stop-color="#F59E0B"/><stop offset="1" stop-color="#ff8a00"/></linearGradient></defs>
      </svg>
      <div class="timer-text" id="timerText">0:00</div>
    </div>
    <div>
      <strong id="nextExerciseName">Repos</strong>
      <span class="small">Temps restant</span>
    </div>
    <button id="skipTimer" class="timer-skip" aria-label="Passer le repos">✕</button>
  </div>
  <div id="modal" class="modal" aria-hidden="true" role="dialog">
    <div class="overlay" id="modalOverlay"></div>
    <div class="content" id="modalContent">
      <button class="close-x" id="modalClose" aria-label="Fermer le modal">✖</button>
      <div id="modalInner"></div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
  <script src="app.js" defer></script>
</body>
</html>
:root {
  --bg: #080b12;
  --card: #0d111a;
  --card-2: #121824;
  --accent: #F59E0B;
  --accent-2: #ff8a00;
  --secondary: #0EA5E9;
  --secondary-2: #2563EB;
  --muted: #8b92a8;
  --success: #10b981;
  --danger: #FF3B30;
  --glass: rgba(255,255,255,0.04);
  --glass-2: rgba(255,255,255,0.02);
  --neon: rgba(245,158,11,0.18);
}

/* RESET & BASE */
* {
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
  margin: 0;
  padding: 0;
}

html, body {
  min-height: 100%;
  background: linear-gradient(180deg, #06070a 0%, #080b12 100%);
  color: #fff;
  font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, 'Helvetica Neue', Arial, sans-serif;
  line-height: 1.5;
  scroll-behavior: smooth;
}

/* ACCESSIBILITÉ : FOCUS VISIBLE */
.btn:focus, button:focus, input:focus, .session-btn:focus {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

/* CONTAINER */
.container {
  max-width: 1100px;
  margin: 18px auto;
  padding: 18px;
}

/* HEADER */
.header {
  display: flex;
  align-items: center;
  gap: 14px;
  margin-bottom: 20px;
}

.logo {
  font-size: 40px;
}

.title {
  font-size: 22px;
  font-weight: 800;
  background: linear-gradient(90deg, var(--accent), var(--accent-2));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}

.small {
  font-size: 13px;
  color: var(--muted);
}

/* FLEX & LAYOUT */
.row {
  display: flex;
  gap: 12px;
  align-items: center;
}

.left {
  flex: 1;
}

.right {
  width: 360px;
}

.programs {
  display: grid;
  grid-template-columns: 1fr 360px;
  gap: 14px;
  margin-top: 18px;
}

/* CARDS */
.card {
  background: var(--card);
  border-radius: 14px;
  padding: 14px;
  border: 1px solid rgba(255,255,255,0.04);
  box-shadow: 0 6px 18px rgba(0,0,0,0.6);
}

/* SESSION & EXERCISE LIST */
.session-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.session-btn {
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  border: none;
  padding: 16px;
  border-radius: 12px;
  color: #071021;
  font-weight: 800;
  cursor: pointer;
  box-shadow: 0 8px 24px rgba(245,158,11,0.12);
  text-align: left;
  transition: all 0.25s ease;
}

.session-btn:hover {
  transform: scale(1.03);
  box-shadow: 0 10px 28px rgba(255, 160, 0, 0.45);
}

/* BUTTONS */
.dashboard-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 10px;
}

.btn {
  background: var(--card-2);
  border: 1px solid rgba(255,255,255,0.03);
  color: #fff;
  padding: 10px 12px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.25s ease;
}

.btn.primary {
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  color: #071021;
  font-weight: 700;
  border: none;
}

/* WEEK CARD */
.week-card {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  padding: 16px;
  border-radius: 12px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  border: 1px solid rgba(255,255,255,0.03);
}

/* EXERCISES */
.exercise-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 14px;
}

.exercise-card {
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.03);
  background: linear-gradient(180deg, var(--card), var(--card-2));
}

.exercise-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px;
  cursor: pointer;
}

.exercise-name {
  font-weight: 800;
  color: var(--accent);
}

.exercise-meta {
  color: var(--muted);
  font-size: 13px;
}

/* DETAILS ACCORDION */
.exercise-details {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.35s;
  padding: 0 14px;
  background: rgba(255,255,255,0.01);
}
.exercise-details.open {
  max-height: 1200px;
  padding: 14px;
}

/* SET ROWS */
.set-row {
  display: grid;
  grid-template-columns: 50px 1fr 1fr 44px;
  gap: 6px;
  padding: 6px;
  background: var(--glass);
  border-radius: 10px;
  align-items: center;
  margin-bottom: 6px;
}

.set-input {
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.08);
  padding: 10px 12px;
  border-radius: 10px;
  color: #fff;
  font-weight: 600;
  text-align: center;
  font-size: 14px;
  transition: all 0.25s;
  height: 42px;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.set-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 10px rgba(255,138,0,0.4), inset 0 2px 4px rgba(0,0,0,0.1);
}

.set-checkbox {
  display: none;
}

.set-checkbox+label {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.05);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  background: var(--card-2);
  font-size: 12px;
  transition: all 0.2s ease;
}

.set-checkbox:checked+label {
  background: var(--success);
  border-color: var(--success);
  transform: scale(1.08);
}

/* TECHNIQUE BANNER */
.technique-banner {
  background: linear-gradient(135deg, var(--neon), rgba(251,191,36,0.08));
  border: 1px solid rgba(245,158,11,0.2);
  padding: 10px;
  border-radius: 10px;
  color: var(--accent);
  font-weight: 700;
  margin-bottom: 12px;
  text-align: center;
}

/* REST TIMER */
.rest-timer {
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  bottom: 18px;
  background: var(--card);
  padding: 14px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.04);
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 999;
  box-shadow: 0 12px 40px rgba(0,0,0,0.6);
}

.timer-circle {
  width: 72px;
  height: 72px;
  position: relative;
}

.timer-text {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  color: var(--accent);
}

.timer-skip {
  background: transparent;
  border: 2px solid rgba(239,68,68,0.25);
  color: var(--danger);
  width: 44px;
  height: 44px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
}

.timer-skip:hover {
  background: rgba(239,68,68,0.1);
}

/* MODAL */
.modal {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 18px;
  z-index: 1200;
}
.modal.active {
  display: flex;
}
.modal .overlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(4px);
}
.modal .content {
  position: relative;
  background: rgba(13,17,26,0.95);
  padding: 18px;
  border-radius: 16px;
  max-width: 940px;
  width: 100%;
  border: 1px solid rgba(255,255,255,0.06);
  max-height: 80vh;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  backdrop-filter: blur(14px) saturate(160%);
  box-shadow: 0 8px 40px rgba(0,0,0,0.65);
}

.close-x {
  position: absolute;
  right: 12px;
  top: 12px;
  cursor: pointer;
  color: var(--accent);
  font-size: 18px;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background 0.2s ease;
}
.close-x:hover {
  background: rgba(255,255,255,0.05);
}

/* CHARTS & HEATMAP */
.chart-container {
  background: rgba(15,20,30,0.85);
  border-radius: 14px;
  padding: 14px;
  border: 1px solid rgba(255,255,255,0.05);
  box-shadow: inset 0 0 10px rgba(255,255,255,0.05);
  color: #fff;
}

.chart-title {
  font-weight: 800;
  color: var(--accent);
  margin-bottom: 6px;
}

.chart-sub {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 10px;
}

.charts {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 12px;
}

.footer {
  margin-top: 30px;
  color: var(--muted);
  font-size: 13px;
  text-align: center;
}

/* HEATMAP GRID */
.heatmap {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
  margin-top: 8px;
}

.heat-cell {
  background: rgba(255,255,255,0.02);
  height: 40px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: var(--muted);
}
.heat-cell.c1 { background: rgba(255,120,0,0.06); }
.heat-cell.c2 { background: rgba(255,120,0,0.12); }
.heat-cell.c3 { background: rgba(255,120,0,0.22); }
.heat-cell.c4 { background: rgba(255,120,0,0.34); }

.heat-legend {
  display: flex;
  gap: 6px;
  align-items: center;
  margin-top: 8px;
}
.legend-pill {
  padding: 6px 8px;
  border-radius: 8px;
  background: rgba(255,255,255,0.02);
  font-size: 12px;
}

/* STATS GRID */
.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

/* MUSCLE TAGS */
.muscle-tag {
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
}

/* EXERCISE ACTIONS */
.exercise-actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  flex-wrap: wrap;
}

/* BUTTON IOS STYLE */
.btn.ios {
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  color: #0b0f17;
  border: none;
  font-weight: 700;
  transition: all 0.25s ease;
  box-shadow: 0 4px 16px rgba(255, 138, 0, 0.35);
  border-radius: 12px;
}
.btn.ios:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 24px rgba(255, 138, 0, 0.5);
}
.btn.ios.primary {
  background: linear-gradient(135deg, var(--secondary), var(--secondary-2));
  color: #fff;
  box-shadow: 0 4px 16px rgba(14,165,233,0.3);
}
.btn.ios.danger {
  background: linear-gradient(135deg, #FF3B30, #FF2D55);
  color: white;
  box-shadow: 0 4px 16px rgba(255, 59, 48, 0.3);
}

.session-btn.ios {
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  color: white;
  font-weight: 700;
  border: none;
  box-shadow: 0 4px 20px rgba(245,158,11,0.3);
  transition: all 0.25s ease;
}
.session-btn.ios:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 24px rgba(255, 138, 0, 0.5);
}

/* HEATMAP PREMIUM */
#heatmapPremium {
  margin-top: 18px;
  background: rgba(10,14,22,0.55);
  backdrop-filter: blur(18px) saturate(180%);
  border-radius: 20px;
  padding: 18px;
  border: 1px solid rgba(255,255,255,0.05);
  box-shadow: 0 8px 32px rgba(0,0,0,0.6);
}
#heatmapPremium .title {
  font-weight: 900;
  color: var(--accent, #F59E0B);
  margin-bottom: 12px;
  text-shadow: 0 0 12px rgba(255,160,30,0.4);
  font-size: 18px;
}
.hm-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}
.weekNav button {
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.08);
  padding: 8px 12px;
  border-radius: 10px;
  color: #fff;
  font-weight: 600;
  backdrop-filter: blur(8px);
  cursor: pointer;
  transition: all 0.2s;
}
.weekNav button:hover {
  background: rgba(255,255,255,0.18);
  transform: translateY(-2px);
}
.legendPill {
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  color: #bfc9d9;
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 13px;
}
.weekCol {
  display: flex;
  flex-direction: column;
  gap: 8px;
  align-items: center;
  min-width: 86px;
}
.weekLabel {
  font-size: 13px;
  color: #8a97b5;
  margin-bottom: 4px;
}
.dayCell {
  width: 72px;
  height: 52px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-weight: 700;
  position: relative;
  cursor: pointer;
  transition: all 0.18s ease;
  box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
}
.dayCell:hover {
  transform: scale(1.08);
  box-shadow: 0 0 16px rgba(255,255,255,0.12);
}
.c-none { background: rgba(20,24,32,0.8); color: #777; }
.c-low  { background: linear-gradient(135deg, #1e293b, #334155); box-shadow: inset 0 0 10px rgba(88,168,255,0.3); }
.c-mid  { background: linear-gradient(135deg, #0ea5e9, #2563eb); box-shadow: inset 0 0 15px rgba(59,130,246,0.4); }
.c-high { background: linear-gradient(135deg, #f59e0b, #f97316); color: #000; box-shadow: 0 0 18px rgba(245,158,11,0.6); }
.c-max  { background: linear-gradient(135deg, #ef4444, #f59e0b); color: #000; box-shadow: 0 0 22px rgba(239,68,68,0.6); }
.hm-small {
  font-size: 11px;
  color: rgba(255,255,255,0.8);
  margin-top: 3px;
}
.hm-tooltip {
  position: absolute;
  z-index: 9999;
  background: rgba(10,12,17,0.92);
  color: #fff;
  padding: 8px 10px;
  border-radius: 8px;
  font-size: 13px;
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 8px 32px rgba(0,0,0,0.6);
  pointer-events: none;
  transform: translate(-50%, -110%);
  white-space: nowrap;
}

/* TOGGLE */
.view-toggle-container {
  display: flex;
  justify-content: center;
  margin: 12px 0;
}
#viewToggle {
  background: linear-gradient(135deg, var(--secondary), var(--secondary-2));
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 16px rgba(14,165,233,0.3);
  transition: all 0.25s ease;
}
#viewToggle:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(14,165,233,0.4);
}

/* PLACEHOLDER */
.set-input::placeholder {
  color: rgba(255,255,255,0.3);
  font-weight: 500;
}

/* INPUT GROUP */
.input-group {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 12px;
}
.input-label {
  color: var(--muted);
  font-size: 13px;
  margin-bottom: 6px;
  font-weight: 600;
}

/* VOLUME GRID */
.volume-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 12px;
}
.volume-item {
  padding: 10px;
  background: var(--card-2);
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.05);
}

/* RESPONSIVE DESIGN */
@media (max-width: 980px) {
  .programs {
    grid-template-columns: 1fr;
  }
  .right {
    width: 100%;
  }
  .charts {
    grid-template-columns: 1fr;
  }
  .stats-grid {
    grid-template-columns: 1fr;
  }
  .volume-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 720px) {
  .chart-container {
    padding: 10px;
  }
  .dayCell {
    width: 60px;
    height: 44px;
    font-size: 12px;
  }
  .weekCol {
    min-width: 70px;
  }
}

@media (max-width: 430px) {
  .container {
    padding: 12px;
    margin: 12px auto;
  }
  .programs {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  .set-row {
    grid-template-columns: 45px 1fr 1fr 40px;
    gap: 4px;
    padding: 4px;
  }
  .set-input {
    padding: 4px;
    font-size: 12px;
  }
  .set-checkbox+label {
    width: 32px;
    height: 32px;
    font-size: 11px;
  }
  .exercise-header {
    padding: 12px;
  }
  .exercise-details.open {
    padding: 12px;
  }
  .session-btn {
    padding: 14px;
  }
  .btn {
    padding: 8px 10px;
    font-size: 13px;
  }
  .dashboard-actions {
    gap: 6px;
  }
  .charts {
    grid-template-columns: 1fr;
  }
}

/* SAFE AREAS */
@supports (padding: max(0px)) {
  .container {
    padding-left: max(12px, env(safe-area-inset-left));
    padding-right: max(12px, env(safe-area-inset-right));
    padding-bottom: max(12px, env(safe-area-inset-bottom));
  }
}

/* iOS / TOUCH SUPPORT */
@supports (-webkit-touch-callout: none) {
  .exercise-details {
    overflow-y: visible !important;
  }
  .set-row {
    overflow: visible !important;
  }
  input.set-checkbox + label {
    min-width: 40px;
    min-height: 40px;
  }
}

/* ANIMATIONS & TRANSITIONS */
* {
  transition: background 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
}
// Hybride Master 51 - JavaScript principal

// ============================
// DONNÉES ET CONFIGURATION
// ============================
const MUSCLE_MAPPING = {
  "Trap Bar Deadlift": { primary:["Ischios","Fessiers","Dos"], secondary:["Quadriceps","Abdominaux"], tertiary:["Mollets","Avant-bras"] },
  "Goblet Squat": { primary:["Quadriceps","Fessiers"], secondary:["Ischios","Abdominaux"], tertiary:["Mollets"] },
  "Leg Press": { primary:["Quadriceps","Ischios"], secondary:["Fessiers"], tertiary:["Mollets"] },
  "Lat Pulldown": { primary:["Dos"], secondary:["Biceps"], tertiary:["Avant-bras"] },
  "Landmine Press": { primary:["Épaules","Triceps"], secondary:["Pectoraux"], tertiary:[] },
  "Rowing Machine": { primary:["Dos"], secondary:["Biceps"], tertiary:["Avant-bras"] },
  "Spider Curl": { primary:["Biceps"], secondary:["Avant-bras"], tertiary:[] },
  "Incline Curl": { primary:["Biceps"], secondary:["Avant-bras"], tertiary:[] },
  "Cable Pushdown": { primary:["Triceps"], secondary:["Avant-bras"], tertiary:[] },
  "Dumbbell Press": { primary:["Pectoraux"], secondary:["Triceps","Épaules"], tertiary:[] },
  "Cable Fly": { primary:["Pectoraux"], secondary:[], tertiary:[] },
  "Leg Press léger": { primary:["Quadriceps"], secondary:["Ischios","Fessiers"], tertiary:["Mollets"] },
  "Extension Triceps Corde": { primary:["Triceps"], secondary:["Avant-bras"], tertiary:[] },
  "Lateral Raises": { primary:["Épaules latérales"], secondary:["Trapèzes"], tertiary:[] },
  "Face Pull": { primary:["Épaules postérieures","Trapèzes"], secondary:["Dos"], tertiary:[] },
  "Overhead Extension": { primary:["Triceps longs"], secondary:[], tertiary:[] },
  "Landmine Row": { primary:["Dos"], secondary:["Biceps"], tertiary:["Avant-bras"] },
  "Leg Curl": { primary:["Ischios"], secondary:["Fessiers"], tertiary:["Mollets"] },
  "Leg Extension": { primary:["Quadriceps"], secondary:[], tertiary:[] },
  "Dumbbell Fly": { primary:["Pectoraux"], secondary:["Épaules"], tertiary:[] },
  "EZ Bar Curl": { primary:["Biceps"], secondary:["Avant-bras"], tertiary:[] },
  "Wrist Curl": { primary:["Avant-bras"], secondary:[], tertiary:[] },
  "Hammer Curl": { primary:["Biceps","Avant-bras"], secondary:[], tertiary:[] }
};

// Configuration de progression automatique
const PROGRESSION_CONFIG = {
  "Trap Bar Deadlift": { depart: 75, increment: 5, frequence: 3 },
  "Goblet Squat": { depart: 25, increment: 2.5, frequence: 2 },
  "Leg Press": { depart: 110, increment: 10, frequence: 2 },
  "Leg Press léger": { depart: 80, increment: 10, frequence: 3 },
  "Lat Pulldown": { depart: 60, increment: 2.5, frequence: 2 },
  "Rowing Machine": { depart: 50, increment: 2.5, frequence: 2 },
  "Landmine Press": { depart: 35, increment: 2.5, frequence: 2 },
  "Landmine Row": { depart: 55, increment: 2.5, frequence: 2 },
  "Dumbbell Press": { depart: 22, increment: 2.5, frequence: 3 },
  "Cable Fly": { depart: 10, increment: 2.5, frequence: 3 },
  "Dumbbell Fly": { depart: 10, increment: 2.5, frequence: 3 },
  "Leg Curl": { depart: 40, increment: 5, frequence: 3 },
  "Leg Extension": { depart: 35, increment: 5, frequence: 3 },
  "Extension Triceps Corde": { depart: 20, increment: 2.5, frequence: 3 },
  "Overhead Extension": { depart: 15, increment: 2.5, frequence: 3 },
  "Cable Pushdown": { depart: 20, increment: 2.5, frequence: 3 },
  "Lateral Raises": { depart: 8, increment: 2.5, frequence: 4 },
  "Face Pull": { depart: 20, increment: 2.5, frequence: 3 },
  "Spider Curl": { depart: 12, increment: 2.5, frequence: 3 },
  "Incline Curl": { depart: 12, increment: 2.5, frequence: 3 },
  "EZ Bar Curl": { depart: 25, increment: 2.5, frequence: 3 },
  "Hammer Curl": { depart: 12, increment: 2.5, frequence: 3 },
  "Wrist Curl": { depart: 30, increment: 2.5, frequence: 4 }
};

const DELOAD_WEEKS = [6, 12, 18, 24, 26];

const PROGRAM = {
  dimanche: {
    key:'dimanche', 
    title: "Dimanche - Dos + Jambes Lourdes + Bras (68 min)",
    exercises:[
      { name:"Trap Bar Deadlift", sets:5, reps:"6-8", rest:120, weight:75, type:"barre", tech:"RPE 6-8" },
      { name:"Goblet Squat", sets:4, reps:"10", rest:75, weight:25, type:"haltères", tech:"Tempo 3-1-2" },
      { name:"Leg Press", sets:4, reps:"10", rest:75, weight:110, type:"machine", tech:"Drop-set dernière série" },
      { name:"Lat Pulldown", sets:4, reps:"10", rest:90, weight:60, type:"machine", tech:"Myo-reps" },
      { name:"Landmine Press", sets:4, reps:"10", rest:90, weight:35, type:"barre", tech:"Tempo 2-1-2" },
      { name:"Rowing Machine", sets:4, reps:"10", rest:75, weight:50, type:"machine", tech:"Tempo 2-1-2" },
      { name:"Spider Curl / Incline Curl*", sets:4, reps:"12", rest:75, weight:12, type:"haltères", tech:"Rest-pause" },
      { name:"Cable Pushdown", sets:3, reps:"12", rest:75, weight:20, type:"machine", tech:"Rest-pause" }
    ]
  },
  mardi: {
    key:'mardi', 
    title:"Mardi - Pecs + Épaules + Triceps (70 min)",
    exercises:[
      { name:"Dumbbell Press", sets:5, reps:"10", rest:105, weight:22, type:"haltères", tech:"Cluster sets" },
      { name:"Cable Fly", sets:4, reps:"12", rest:60, weight:10, type:"machine", tech:"Tension continue" },
      { name:"Leg Press léger", sets:3, reps:"15", rest:60, weight:80, type:"machine", tech:"Standard" },
      { name:"Extension Triceps Corde", sets:5, reps:"12", rest:75, weight:20, type:"machine", tech:"Drop-set" },
      { name:"Lateral Raises", sets:5, reps:"15", rest:75, weight:8, type:"haltères", tech:"Myo-reps" },
      { name:"Face Pull", sets:5, reps:"15", rest:60, weight:20, type:"machine", tech:"Tempo 3-1-2" },
      { name:"Rowing Machine", sets:4, reps:"12", rest:75, weight:50, type:"machine", tech:"Tempo 2-1-2" },
      { name:"Overhead Extension", sets:4, reps:"12", rest:60, weight:15, type:"machine", tech:"Rest-pause" }
    ]
  },
  vendredi: {
    key:'vendredi', 
    title:"Vendredi - Dos + Jambes + Bras + Épaules (73 min)",
    exercises:[
      { name:"Landmine Row", sets:5, reps:"10", rest:105, weight:55, type:"barre", tech:"Tempo 2-1-2" },
      { name:"Leg Curl", sets:5, reps:"12", rest:75, weight:40, type:"machine", tech:"Drop-set dernière série" },
      { name:"Leg Extension", sets:4, reps:"15", rest:75, weight:35, type:"machine", tech:"Standard" },
      { name:"Cable Fly", sets:4, reps:"15", rest:60, weight:10, type:"machine", tech:"Tension continue" },
      { name:"Dumbbell Fly", sets:4, reps:"12", rest:75, weight:10, type:"haltères", tech:"Tempo 3-1-2" },
      { name:"EZ Bar Curl", sets:5, reps:"12", rest:75, weight:25, type:"barre", tech:"Rest-pause" },
      { name:"Overhead Extension", sets:3, reps:"12", rest:75, weight:15, type:"machine", tech:"Rest-pause" },
      { name:"Lateral Raises", sets:3, reps:"15", rest:60, weight:8, type:"haltères", tech:"Myo-reps" },
      { name:"Wrist Curl", sets:3, reps:"20", rest:45, weight:30, type:"barre", tech:"Standard" }
    ]
  },
  maison: {
    key:'maison', 
    title:"Séance Maison - Mardi & Jeudi soir",
    exercises:[
      { name:"Hammer Curl", sets:3, reps:"12", rest:60, weight:12, type:"haltères", tech:"Standard" }
    ]
  }
};

// ============================
// FONCTIONS DE PROGRESSION AVANCÉES
// ============================

function getCurrentBlock(semaine) {
  if (semaine <= 5) return 1;
  if (semaine <= 11) return 2;
  if (semaine <= 17) return 3;
  if (semaine <= 25) return 4;
  return 1;
}

function isDeloadWeek(semaine) {
  return DELOAD_WEEKS.includes(semaine);
}

function getBicepsExercise(semaine) {
  const bloc = getCurrentBlock(semaine);
  if (bloc === 1 || bloc === 3) return "Incline Curl";
  if (bloc === 2 || bloc === 4) return "Spider Curl";
  return "Incline Curl";
}

function calculerCharge(exerciceNom, semaine) {
  const config = PROGRESSION_CONFIG[exerciceNom];
  if (!config) return 0;
  
  const base = config.depart;
  const increment = config.increment;
  const frequence = config.frequence;
  
  let progressions = 0;
  for (let s = 1; s <= semaine; s++) {
    if (!isDeloadWeek(s) && s % frequence === 1 && s > 1) {
      progressions++;
    }
  }
  
  let charge = base + (increment * progressions);
  
  // Application deload
  if (isDeloadWeek(semaine)) {
    charge = Math.round(charge * 0.6 * 2) / 2;
  }
  
  return charge;
}

function updateAllWeights() {
  Object.keys(PROGRESSION_CONFIG).forEach(exercice => {
    state.weights[exercice] = calculerCharge(exercice, state.week);
  });
  saveState();
}

function getTechniqueDetails(exercice, semaine) {
  const bloc = getCurrentBlock(semaine);
  const isDeload = isDeloadWeek(semaine);
  
  if (isDeload) {
    return "DELOAD: Charge réduite à 60%, tempo 4-1-2, RPE 5-6";
  }
  
  switch(bloc) {
    case 1:
      return getBloc1Technique(exercice);
    case 2:
      return getBloc2Technique(exercice);
    case 3:
      return getBloc3Technique(exercice);
    case 4:
      return getBloc4Technique(exercice);
    default:
      return "Standard";
  }
}

function getBloc1Technique(exercice) {
  const techniques = {
    "Cable Fly": "Tempo 3-1-2 • Pause 2s bras écartés",
    "Dumbbell Fly": "Tempo 3-1-2 • Pause 2s bras écartés", 
    "Incline Curl": "Tempo 3-1-2 • Pause 2s bras tendus",
    "EZ Bar Curl": "Tempo 3-1-2 • Pause 2s bras tendus",
    "Lateral Raises": "Tempo 3-1-2 • Pause 1s bras horizontaux",
    "Face Pull": "Tempo 3-1-2 • Pause 1s contraction",
    "default": "Tempo 3-1-2 • RPE 6-7"
  };
  return techniques[exercice] || techniques.default;
}

function getBloc2Technique(exercice) {
  const restPause = {
    "Trap Bar Deadlift": "Rest-Pause S5: 6-8 reps → 20s repos → 2-3 reps",
    "Dumbbell Press": "Rest-Pause S5: 10 reps → 20s repos → 3-4 reps", 
    "Landmine Row": "Rest-Pause S5: 10 reps → 20s repos → 3-4 reps",
    "default": "Tempo 2-1-2 • RPE 7-8"
  };
  return restPause[exercice] || restPause.default;
}

function getBloc3Technique(exercice) {
  const dropSets = {
    "Goblet Squat": "Drop-Set S4: -25% → 8-10 reps",
    "Leg Press": "Drop-Set S4: -25% → 10-12 reps",
    "Lat Pulldown": "Drop-Set S4: -20% → 8-10 reps",
    "Dumbbell Press": "Drop-Set S5: -25% → 8-10 reps",
    "Cable Fly": "Drop-Set S4: -25% → 10-12 reps",
    "Extension Triceps Corde": "Drop-Set S5: -20% → 10-12 reps",
    "Lateral Raises": "Drop-Set S5: -25% → 12-15 reps",
    "Landmine Row": "Drop-Set S5: -20% → 8-10 reps", 
    "Leg Curl": "Drop-Set S5: -25% → 10-12 reps",
    "Leg Extension": "Drop-Set S4: -25% → 12-15 reps",
    "Dumbbell Fly": "Drop-Set S4: -25% → 10-12 reps"
  };
  
  const myoReps = {
    "Face Pull": "Myo-Reps S5: 15 reps → 5s repos → 5×5 mini-sets",
    "Overhead Extension": "Myo-Reps S4: 12 reps → 5s repos → 4×4 mini-sets",
    "Incline Curl": "Myo-Reps S4: 12 reps → 5s repos → 4×4 mini-sets", 
    "Spider Curl": "Myo-Reps S4: 12 reps → 5s repos → 4×4 mini-sets",
    "Cable Fly": "Myo-Reps S4: 15 reps → 5s repos → 5×5 mini-sets",
    "Rowing Machine": "Myo-Reps S4: 12 reps → 5s repos → 4×4 mini-sets"
  };
  
  return dropSets[exercice] || myoReps[exercice] || "RPE 8 • Techniques intensification";
}

function getBloc4Technique(exercice) {
  const clusters = {
    "Trap Bar Deadlift": "Cluster S5: 3 reps → 20s → 2 reps → 20s → 2 reps (7 total)",
    "Dumbbell Press": "Cluster S5: 4 reps → 15s → 3 reps → 15s → 3 reps (10 total)",
    "Landmine Row": "Cluster S5: 4 reps → 15s → 3 reps → 15s → 3 reps (10 total)", 
    "Leg Press": "Cluster S4: 4 reps → 20s → 3 reps → 20s → 3 reps (10 total)"
  };
  
  const partials = {
    "Goblet Squat": "Partials S4: 10 reps complètes → 5 demi-reps amplitude haute",
    "Leg Press": "Partials S4: 10 reps complètes → 8 quarts de reps",
    "Leg Curl": "Partials S5: 12 reps complètes → 6-8 partials amplitude haute", 
    "Leg Extension": "Partials S4: 15 reps complètes → 10 partials (derniers 30°)"
  };
  
  const myoRepsAll = [
    "Face Pull", "Lateral Raises", "Overhead Extension", "Cable Fly", 
    "Dumbbell Fly", "Incline Curl", "Spider Curl", "EZ Bar Curl"
  ];
  
  if (myoRepsAll.includes(exercice)) {
    return "Myo-Reps dernière série • RPE 8-9";
  }
  
  return clusters[exercice] || partials[exercice] || "RPE 8-9 • Techniques avancées";
}

function calculateExactMuscleVolumes() {
  return {
    "Quadriceps": 23,
    "Ischios": 17, 
    "Fessiers": 19,
    "Dos": 30,
    "Pectoraux": 22,
    "Épaules postérieures": 12,
    "Épaules latérales": 10,
    "Biceps": 19,
    "Triceps": 20,
    "Avant-bras": 16
  };
}

function getOptimalRange(muscle) {
  const ranges = {
    "Quadriceps": { min: 18, max: 24 },
    "Ischios": { min: 14, max: 20 },
    "Fessiers": { min: 14, max: 20 },
    "Dos": { min: 18, max: 24 },
    "Pectoraux": { min: 16, max: 22 },
    "Épaules postérieures": { min: 10, max: 14 },
    "Épaules latérales": { min: 6, max: 10 },
    "Biceps": { min: 14, max: 20 },
    "Triceps": { min: 12, max: 18 },
    "Avant-bras": { min: 6, max: 12 }
  };
  return ranges[muscle] || { min: 0, max: 0 };
}

// ============================
// TESTS UNITAIRES
// ============================

function runAllTests() {
  console.log("🧪 LANCEMENT DES TESTS UNITAIRES HYBRID MASTER 51");
  
  // Test 1: Charge Trap Bar semaine 26
  const trapBarS26 = calculerCharge("Trap Bar Deadlift", 26);
  console.assert(trapBarS26 === 120, `❌ Trap Bar S26 devrait être 120kg, obtenu: ${trapBarS26}kg`);
  console.log(`✅ Trap Bar S26: ${trapBarS26}kg`);

  // Test 2: Charge Dumbbell Press semaine 12
  const dbPressS12 = calculerCharge("Dumbbell Press", 12);
  console.assert(dbPressS12 === 30, `❌ Dumbbell Press S12 devrait être 30kg, obtenu: ${dbPressS12}kg`);
  console.log(`✅ Dumbbell Press S12: ${dbPressS12}kg`);

  // Test 3: Deload semaine 6
  const isDeloadS6 = isDeloadWeek(6);
  console.assert(isDeloadS6 === true, `❌ Semaine 6 devrait être deload`);
  console.log(`✅ Semaine 6 deload: ${isDeloadS6}`);

  // Test 4: Bloc semaine 15
  const blocS15 = getCurrentBlock(15);
  console.assert(blocS15 === 3, `❌ Semaine 15 devrait être Bloc 3, obtenu: Bloc ${blocS15}`);
  console.log(`✅ Semaine 15: Bloc ${blocS15}`);

  // Test 5: Rotation biceps semaine 9
  const bicepsS9 = getBicepsExercise(9);
  console.assert(bicepsS9 === "Spider Curl", `❌ S9 devrait être Spider Curl, obtenu: ${bicepsS9}`);
  console.log(`✅ S9 Biceps: ${bicepsS9}`);

  // Test 6: Volume Pectoraux
  const volPecs = calculateExactMuscleVolumes().Pectoraux;
  console.assert(volPecs === 22, `❌ Volume Pectoraux devrait être 22, obtenu: ${volPecs}`);
  console.log(`✅ Volume Pectoraux: ${volPecs}`);

  // Test 7: Séries Dimanche
  const seriesDimanche = PROGRAM.dimanche.exercises.reduce((total, ex) => total + ex.sets, 0);
  console.assert(seriesDimanche === 31, `❌ Dimanche devrait avoir 31 séries, obtenu: ${seriesDimanche}`);
  console.log(`✅ Séries Dimanche: ${seriesDimanche}`);

  console.log("🎉 TOUS LES TESTS PASSÉS AVEC SUCCÈS!");
}

// ============================
// ÉTAT ET INITIALISATION
// ============================
const STATE_KEY = 'hm51_v_full_v6';
let state = null;
let currentSessionKey = null;
let currentView = 'week';
let autoSwitchInterval;

function defaultState(){
  const weights = {};
  Object.values(PROGRAM).forEach(s => s.exercises.forEach(e => { 
    weights[e.name] = e.weight; 
  }));
  
  return {
    week: 1,
    program: JSON.parse(JSON.stringify(PROGRAM)),
    weights: weights,
    hist: {},
    customExercises: []
  };
}

function loadState(){
  try{
    const raw = localStorage.getItem(STATE_KEY);
    if(raw) return JSON.parse(raw);
  }catch(e){ 
    console.error("Erreur chargement state:", e);
    return defaultState();
  }
  return defaultState();
}

function saveState(){
  try{ 
    localStorage.setItem(STATE_KEY, JSON.stringify(state));
  }catch(e){ 
    console.error("Erreur sauvegarde state:", e);
  }
}

// ============================
// FONCTIONS UTILITAIRES
// ============================
let quickTimer;
function showQuick(msg, color){
  const el = document.getElementById('quickMsg');
  if(!el) return;
  el.textContent = msg;
  el.style.color = color || '';
  clearTimeout(quickTimer);
  quickTimer = setTimeout(()=>{ 
    el.textContent='Prêt.'; 
    el.style.color=''; 
  }, 2800);
}

function sanitizeId(name){ 
  return name.replace(/[^a-z0-9]/gi,'_'); 
}

// ============================
// GESTION MODALS
// ============================
function openModal(html){
  const modal = document.getElementById('modal');
  const inner = document.getElementById('modalInner');
  inner.innerHTML = html;
  modal.classList.add('active'); 
  modal.setAttribute('aria-hidden','false');
}

function closeModal(){ 
  const modal = document.getElementById('modal'); 
  modal.classList.remove('active'); 
  modal.setAttribute('aria-hidden','true'); 
  document.getElementById('modalInner').innerHTML='';
}

// ============================
// RENDU PRINCIPAL
// ============================
function renderHeader(){
  document.getElementById('weekDisplay').textContent = state.week;
  const blockName = document.getElementById('blockName');
  const bloc = getCurrentBlock(state.week);
  const isDeload = isDeloadWeek(state.week);
  
  if (isDeload) {
    blockName.textContent = 'DELOAD • Charge -40% • RPE 5-6';
    blockName.style.color = 'var(--secondary)';
  } else {
    switch(bloc) {
      case 1:
        blockName.textContent = 'Bloc 1 - Fondation • Tempo 3-1-2 • RPE 6-7';
        break;
      case 2:
        blockName.textContent = 'Bloc 2 - Surcharge • Rest-Pause • RPE 7-8';
        break;
      case 3:
        blockName.textContent = 'Bloc 3 - Surcompensation • Drop-sets + Myo-reps • RPE 8';
        break;
      case 4:
        blockName.textContent = 'Bloc 4 - Intensification • Clusters + Partials • RPE 8-9';
        break;
    }
    blockName.style.color = 'var(--accent)';
  }
}

function renderProgramList(){
  const list = document.getElementById('progList');
  list.innerHTML = '';
  Object.values(state.program).forEach(s=>{
    const totalSets = s.exercises.reduce((a,b)=>a+b.sets,0);
    const btn = document.createElement('button');
    btn.className='session-btn ios';
    btn.innerHTML = `<div style="font-weight:800">${s.title}</div><div class="small">${s.exercises.length} ex • ${totalSets} séries</div>`;
    btn.onclick = ()=> openSession(s.key);
    list.appendChild(btn);
  });
  document.getElementById('customCount').textContent = `${state.customExercises.length} personnalisés`;
}

function renderHeatmap(){
  const el = document.getElementById('heatmap'); 
  el.innerHTML='';
  
  const days = 7;
  const dayVolumes = new Array(days).fill(0);
  const sessionDayMap = { dimanche:0, mardi:2, vendredi:5 };
  
  Object.values(state.program).forEach(sess=>{
    const vol = sess.exercises.reduce((acc,ex)=> {
      const reps = (typeof ex.reps === 'number') ? ex.reps : parseInt(String(ex.reps).split('-')[0])||0;
      const w = state.weights[ex.name] || ex.weight || 0;
      return acc + (w*reps*ex.sets);
    },0);
    const dayIndex = sessionDayMap[sess.key] || 0;
    dayVolumes[dayIndex] += vol;
  });
  
  const max = Math.max(...dayVolumes,1);
  for(let d=0;d<days;d++){
    const v = dayVolumes[d];
    const ratio = v / max;
    let cls='c1';
    if(ratio>0.75) cls='c4'; 
    else if(ratio>0.5) cls='c3'; 
    else if(ratio>0.25) cls='c2';
    
    const cell = document.createElement('div');
    cell.className = 'heat-cell '+cls;
    cell.textContent = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'][d] + ` • ${Math.round(v/1000)}k`;
    el.appendChild(cell);
  }
}

function renderAll(){
  updateAllWeights();
  renderHeader(); 
  renderProgramList(); 
  renderHeatmap();
  if(window.heatmapPremiumRefresh) window.heatmapPremiumRefresh();
}

// ============================
// GESTION SÉANCES
// ============================
function openSession(key){
  currentSessionKey = key;
  const arr = state.program[key].exercises;
  const area = document.getElementById('exerciseArea');
  area.innerHTML = '';
  
  const sessionHeader = document.createElement('div');
  sessionHeader.className = 'card';
  sessionHeader.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-weight:800">${state.program[key].title}</div>
      <div class="exercise-actions">
        <button class="btn ios" onclick="openAddExerciseModal('${key}')">➕ Ajouter</button>
        <button class="btn ios danger" onclick="removeSession('${key}')">🗑️ Supprimer</button>
      </div>
    </div>
  `;
  area.appendChild(sessionHeader);
  
  arr.forEach((ex, index)=>{
    // Gestion rotation biceps
    let exerciseName = ex.name;
    if (ex.name === "Spider Curl / Incline Curl*") {
      exerciseName = getBicepsExercise(state.week);
    }
    
    const exId = sanitizeId(exerciseName);
    const card = document.createElement('div'); 
    card.className='exercise-card';
    const header = document.createElement('div'); 
    header.className='exercise-header';
    
    const currentWeight = calculerCharge(exerciseName, state.week);
    
    header.innerHTML = `<div style="flex:1"><div class="exercise-name">${exerciseName}</div>
      <div class="exercise-meta">${ex.sets}× ${ex.reps} • ${ex.rest}s repos • ${currentWeight}kg</div></div>
      <div class="exercise-arrow" id="arrow-${exId}">▼</div>`;
    header.addEventListener('click', ()=> toggleDetails(ex));
    const details = document.createElement('div'); 
    details.className='exercise-details'; 
    details.id='details-'+exId;
    card.appendChild(header); 
    card.appendChild(details);
    area.appendChild(card);
  });
  window.scrollTo({top:0,behavior:'smooth'});
  showQuick('Séance ouverte');
}

function toggleDetails(ex){
  let exerciseName = ex.name;
  if (ex.name === "Spider Curl / Incline Curl*") {
    exerciseName = getBicepsExercise(state.week);
  }
  
  const exId = sanitizeId(exerciseName);
  const details = document.getElementById('details-'+exId);
  const arrow = document.getElementById('arrow-'+exId);
  if(!details) return;
  
  const isOpen = details.classList.contains('open');
  document.querySelectorAll('.exercise-details.open').forEach(d=>{
    if(d!==details) { 
      d.classList.remove('open'); 
      d.innerHTML=''; 
      const aid = d.id.replace('details-',''); 
      const ar = document.getElementById('arrow-'+aid); 
      if(ar) ar.classList.remove('open'); 
    }
  });
  
  if(isOpen){ 
    details.classList.remove('open'); 
    details.innerHTML=''; 
    if(arrow) arrow.classList.remove('open'); 
    return; 
  }
  
  renderExerciseDetails(ex);
  details.classList.add('open');
  if(arrow) arrow.classList.add('open');
}

function renderExerciseDetails(ex){
  let exerciseName = ex.name;
  if (ex.name === "Spider Curl / Incline Curl*") {
    exerciseName = getBicepsExercise(state.week);
  }
  
  const exId = sanitizeId(exerciseName);
  const details = document.getElementById('details-'+exId);
  if(!details) return;
  
  const w = calculerCharge(exerciseName, state.week);
  const last = (state.hist[exerciseName] && state.hist[exerciseName].length) ? 
    state.hist[exerciseName][state.hist[exerciseName].length-1] : null;
  
  let perfHtml = '';
  if(last) {
    perfHtml = `<div style="background:rgba(16,185,129,0.08);padding:10px;border-radius:8px;border:1px solid rgba(16,185,129,0.12);margin-bottom:10px">Dernière: ${last.weight}kg × ${last.reps} reps (Semaine ${last.week})</div>`;
  } else {
    perfHtml = `<div style="background:rgba(245,158,11,0.06);padding:10px;border-radius:8px;border:1px solid rgba(245,158,11,0.08);margin-bottom:10px">Première fois pour cet exercice</div>`;
  }

  const mm = MUSCLE_MAPPING[exerciseName] || {primary:[],secondary:[],tertiary:[]};
  let muscleHtml = '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">';
  mm.primary.forEach(m=> muscleHtml += `<span class="muscle-tag" style="background:rgba(245,158,11,0.22);color:var(--accent)">${m}</span>`);
  mm.secondary.forEach(m=> muscleHtml += `<span class="muscle-tag" style="background:rgba(59,130,246,0.12);color:#60a5fa">${m}</span>`);
  mm.tertiary.forEach(m=> muscleHtml += `<span class="muscle-tag" style="background:rgba(139,92,246,0.08);color:#b794f4">${m}</span>`);
  muscleHtml += '</div>';

  let setsHtml = '';
  for(let i=1;i<=ex.sets;i++){
    setsHtml += `<div class="set-row">
      <div class="set-label" style="font-size:12px;color:var(--muted)">Série ${i}</div>
      <div><input class="set-input w-${exId}-${i}" type="number" step="0.5" value="${w}" placeholder="KG"></div>
      <div><input class="set-input r-${exId}-${i}" type="number" value="${(typeof ex.reps==='number')?ex.reps:parseInt(String(ex.reps).split('-')[0])}" placeholder="REPS"></div>
      <div><input id="s-${i}-${exId}" class="set-checkbox" type="checkbox"><label for="s-${i}-${exId}">✓</label></div>
    </div>`;
  }

  const techniqueDetails = getTechniqueDetails(exerciseName, state.week);
  
  details.innerHTML = `<div class="technique-banner">✨ ${techniqueDetails}</div>
    ${perfHtml}
    ${muscleHtml}
    ${setsHtml}
    <div class="exercise-actions">
      <button class="btn ios" onclick="openModifyWeight('${encodeURIComponent(exerciseName)}')">✏️ Poids</button>
      <button class="btn ios primary" onclick="savePerf('${encodeURIComponent(exerciseName)}')">💾 Enregistrer</button>
      <button class="btn ios danger" onclick="removeExerciseFromSession('${encodeURIComponent(exerciseName)}')">🗑️ Retirer</button>
    </div>`;

  const checkboxes = details.querySelectorAll('.set-checkbox');
  checkboxes.forEach((cb, idx)=>{
    cb.addEventListener('change', function(){
      if(this.checked){
        if(navigator.vibrate) navigator.vibrate(50);
        const isLast = idx === checkboxes.length - 1;
        const nextText = isLast ? 'Prochain exercice' : 'Repos';
        startRestCountdown(ex.rest, nextText);
      }
    });
  });
}
// ============================
// GESTION DES MODALS SUPPLÉMENTAIRES
// ============================
function openAddExerciseModal(sessionKey) {
  openModal(`
    <h2>Ajouter un exercice</h2>
    <!-- Formulaire d'ajout ici -->
    <input id="newExerciseName" type="text" placeholder="Nom de l'exercice" />
    <button onclick="addExercise('${sessionKey}')">Ajouter</button>
  `);
}

function addExercise(sessionKey) {
  const name = document.getElementById('newExerciseName').value.trim();
  if (!name) {
    showQuick("Nom d'exercice requis", "var(--danger)");
    return;
  }
  // Ajoute l'exercice à la session
  state.program[sessionKey].exercises.push({
    name: name,
    sets: 3,
    reps: "10",
    rest: 60,
    weight: 10,
    type: "custom",
    tech: "Standard"
  });
  saveState();
  closeModal();
  renderAll();
  showQuick("Exercice ajouté !");
}

function openDayExerciseManager() {
  openModal(`
    <h2>Gérer les exercices du jour</h2>
    <div>
      <!-- Liste des exercices -->
      ${Object.keys(state.program).map(key => `
        <div>
          <strong>${state.program[key].title}</strong>
          <button onclick="openSession('${key}')">Ouvrir</button>
        </div>
      `).join('')}
    </div>
  `);
}

function removeSession(sessionKey) {
  if (confirm(`Supprimer la séance ${state.program[sessionKey].title} ?`)) {
    delete state.program[sessionKey];
    saveState();
    closeModal();
    renderAll();
    showQuick("Séance supprimée !");
  }
}

function openModifyWeight(exerciseName) {
  exerciseName = decodeURIComponent(exerciseName);
  openModal(`
    <h2>Modifier le poids pour ${exerciseName}</h2>
    <input id="weightInput" type="number" step="0.5" min="0" value="${state.weights[exerciseName] || 0}" />
    <button onclick="saveNewWeight('${encodeURIComponent(exerciseName)}')">Sauver</button>
  `);
}

function saveNewWeight(exerciseName) {
  exerciseName = decodeURIComponent(exerciseName);
  const weight = parseFloat(document.getElementById('weightInput').value);
  if (isNaN(weight) || weight < 0) {
    showQuick("Poids invalide", "var(--danger)");
    return;
  }
  state.weights[exerciseName] = weight;
  saveState();
  closeModal();
  renderAll();
  showQuick("Poids mis à jour !");
}

function removeExerciseFromSession(exerciseName) {
  exerciseName = decodeURIComponent(exerciseName);
  const session = state.program[currentSessionKey];
  session.exercises = session.exercises.filter(e => e.name !== exerciseName);
  saveState();
  renderAll();
  showQuick("Exercice retiré !");
  closeModal();
}

function savePerf(exerciseName) {
  exerciseName = decodeURIComponent(exerciseName);
  // Exemple rapide : sauvegarde la perf sur la dernière série
  const repsInputs = document.querySelectorAll(`.set-input.r-${sanitizeId(exerciseName)}-1`);
  const weightInputs = document.querySelectorAll(`.set-input.w-${sanitizeId(exerciseName)}-1`);
  let reps = repsInputs.length ? parseInt(repsInputs[0].value) : 0;
  let weight = weightInputs.length ? parseFloat(weightInputs[0].value) : 0;
  if (!state.hist[exerciseName]) state.hist[exerciseName] = [];
  state.hist[exerciseName].push({ week: state.week, reps, weight });
  saveState();
  showQuick("Performance enregistrée !");
}

function startRestCountdown(seconds, nextText) {
  const timerContainer = document.getElementById('restTimer');
  const timerText = document.getElementById('timerText');
  timerContainer.style.display = 'flex';
  let remaining = seconds;
  timerText.textContent = `${Math.floor(remaining/60)}:${String(remaining%60).padStart(2,"0")}`;
  const interval = setInterval(() => {
    remaining--;
    timerText.textContent = `${Math.floor(remaining/60)}:${String(remaining%60).padStart(2,"0")}`;
    if (remaining <= 0) {
      clearInterval(interval);
      timerContainer.style.display = 'none';
      showQuick(`${nextText} !`, "var(--success)");
    }
  }, 1000);
  document.getElementById('skipTimer').onclick = () => {
    clearInterval(interval);
    timerContainer.style.display = 'none';
    showQuick("Repos passé !");
  };
}

// ============================
// INITIALISATION
// ============================

function init() {
  state = loadState();
  renderAll();

  // Navigation semaine
  document.getElementById('prevWeek').onclick = () => {
    if (state.week > 1) {
      state.week--;
      saveState();
      renderAll();
    }
  };
  document.getElementById('nextWeek').onclick = () => {
    if (state.week < 26) {
      state.week++;
      saveState();
      renderAll();
    }
  };

  // Vue Exercices / Vue Semaine
  document.getElementById('viewToggle').onclick = () => {
    currentView = currentView === 'week' ? 'exercises' : 'week';
    renderAll();
  };

  // Modal close
  document.getElementById('modalClose').onclick = closeModal;
  document.getElementById('modalOverlay').onclick = closeModal;

  // Statistiques, backup, reset
  document.getElementById('openStats').onclick = () => { openModal('<h2>Statistiques</h2><div>À venir…</div>'); };
  document.getElementById('openStatsHist').onclick = () => { openModal('<h2>Progression</h2><div>À venir…</div>'); };
  document.getElementById('openVolume').onclick = () => { openModal('<h2>Volume</h2><div>À venir…</div>'); };
  document.getElementById('openMuscle').onclick = () => { openModal('<h2>Muscles</h2><div>À venir…</div>'); };
  document.getElementById('exportCSV').onclick = () => { openModal('<h2>Export CSV</h2><div>À venir…</div>'); };
  document.getElementById('backupBtn').onclick = () => { openModal('<h2>Backup</h2><div>À venir…</div>'); };
  document.getElementById('resetApp').onclick = () => {
    if (confirm("Réinitialiser l'application ?")) {
      localStorage.removeItem(STATE_KEY);
      state = defaultState();
      renderAll();
      showQuick("Application réinitialisée !");
    }
  };

  runAllTests();
}

window.onload = init;
// ============================
// GESTION HEATMAP PREMIUM ET NAVIGATION
// ============================
function heatmapPremiumRefresh() {
  const grid = document.getElementById('heatmapGrid');
  grid.innerHTML = '';
  // Affiche la heatmap premium sur 4 semaines
  let startWeek = Math.max(1, state.week - 3);
  let endWeek = state.week;
  // Simule les données (à compléter selon logique métier)
  for (let week = startWeek; week <= endWeek; week++) {
    let volume = 0;
    let series = 0;
    Object.values(PROGRAM).forEach(session => {
      session.exercises.forEach(ex => {
        volume += calculerCharge(ex.name, week) * ex.sets;
        series += ex.sets;
      });
    });
    const weekCol = document.createElement('div');
    weekCol.className = 'weekCol';
    weekCol.innerHTML = `
      <div class="weekLabel">S${week}</div>
      <div class="dayCell c-mid">${Math.round(volume / 1000)}k</div>
      <div class="hm-small">Séries: ${series}</div>
    `;
    grid.appendChild(weekCol);
  }
  document.getElementById('hmRangeLabel').textContent = `S${startWeek} à S${endWeek}`;
}

document.getElementById('hmPrev').onclick = () => {
  if (state.week > 4) {
    state.week -= 4;
    saveState();
    renderAll();
  }
};
document.getElementById('hmNext').onclick = () => {
  if (state.week < 23) {
    state.week += 4;
    saveState();
    renderAll();
  }
};

// ============================
// AUTRES FONCTIONS AVANCÉES
// ============================
// Ajouter ici les modules avancés, gestion des exercices personnalisés, import/export, etc.

// Exemple : Ajouter un exercice indépendant
document.getElementById('addIndependent').onclick = () => {
  openModal(`
    <h2>Créer un exercice indépendant</h2>
    <input id="indepExerciseName" type="text" placeholder="Nom de l'exercice" />
    <button onclick="addIndependentExercise()">Créer</button>
  `);
};
function addIndependentExercise() {
  const name = document.getElementById('indepExerciseName').value.trim();
  if (!name) {
    showQuick("Nom requis", "var(--danger)");
    return;
  }
  state.customExercises.push({ name: name, sets: 3, reps: 12, weight: 10 });
  saveState();
  closeModal();
  renderAll();
  showQuick("Exercice indépendant ajouté !");
}

// Exemple : Voir les exercices personnalisés
document.getElementById('viewCustom').onclick = () => {
  openModal(`
    <h2>Exercices personnalisés</h2>
    <ul>
      ${state.customExercises.map(ex => `<li>${ex.name} (${ex.sets}×${ex.reps}, ${ex.weight}kg)</li>`).join('')}
    </ul>
  `);
};

// Exemple : Gérer les séances personnalisées
document.getElementById('manageSessionExercises').onclick = () => {
  openModal(`
    <h2>Gérer les séances</h2>
    <div>
      ${Object.keys(state.program).map(key => `
        <div>
          <strong>${state.program[key].title}</strong>
          <button onclick="openSession('${key}')">Ouvrir</button>
        </div>
      `).join('')}
    </div>
  `);
};

// ============================
// GESTION DU BACKUP & EXPORT
// ============================
document.getElementById('backupBtn').onclick = () => {
  const backupData = JSON.stringify(state, null, 2);
  openModal(`
    <h2>Backup</h2>
    <textarea style="width:100%;height:200px;">${backupData}</textarea>
    <div>
      <button onclick="closeModal()">Fermer</button>
    </div>
  `);
};

document.getElementById('exportCSV').onclick = () => {
  let csv = "Exercice, Semaine, Reps, Poids\n";
  Object.keys(state.hist).forEach(name => {
    state.hist[name].forEach(perf => {
      csv += `${name},${perf.week},${perf.reps},${perf.weight}\n`;
    });
  });
  openModal(`
    <h2>Export CSV</h2>
    <textarea style="width:100%;height:200px;">${csv}</textarea>
    <div>
      <button onclick="closeModal()">Fermer</button>
    </div>
  `);
};

// ============================
// GESTION DU RESET ET FINALISATION
// ============================
document.getElementById('resetApp').onclick = () => {
  if (confirm("Réinitialiser l'application ?")) {
    localStorage.removeItem(STATE_KEY);
    state = defaultState();
    renderAll();
    showQuick("Application réinitialisée !");
  }
};

// FOCUS ACCESSIBILITÉ SUR LES MODALS
document.addEventListener('keydown', function(e) {
  if (e.key === "Escape") {
    closeModal();
  }
});
// ============================
// HELPERS & EXTENSIONS
// ============================

// Responsive recalculation for dynamic resizing
window.addEventListener('resize', () => {
  if (window.innerWidth < 600) {
    document.body.classList.add('mobile');
  } else {
    document.body.classList.remove('mobile');
  }
});

// Helper: Format date in French
function formatDateFr(date) {
  return date.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
}

// Helper: Deep clone for objects
function deepClone(obj) {
  return JSON.parse(JSON.stringify(obj));
}

// Helper: Get total volume for a week
function getWeekVolume(weekNumber) {
  let volume = 0;
  Object.values(PROGRAM).forEach(session => {
    session.exercises.forEach(ex => {
      volume += calculerCharge(ex.name, weekNumber) * ex.sets;
    });
  });
  return volume;
}

// Helper: Get total series for a week
function getWeekSeries(weekNumber) {
  let series = 0;
  Object.values(PROGRAM).forEach(session => {
    session.exercises.forEach(ex => {
      series += ex.sets;
    });
  });
  return series;
}

// Helper: Export all historical performances
function exportHistoryJSON() {
  return JSON.stringify(state.hist, null, 2);
}

// Helper: Import performances from JSON
function importHistoryJSON(json) {
  try {
    state.hist = JSON.parse(json);
    saveState();
    renderAll();
    showQuick("Historique importé !");
  } catch (e) {
    showQuick("Erreur import JSON", "var(--danger)");
  }
}

// Helper: Clear all local storage except state
function clearLocalStorageExceptState() {
  Object.keys(localStorage).forEach(key => {
    if (key !== STATE_KEY) localStorage.removeItem(key);
  });
}

// Helper: Set focus in modal for accessibility
function setModalFocus() {
  const modal = document.querySelector('.modal.active');
  if (modal) {
    const firstInput = modal.querySelector('input, button, textarea, select');
    if (firstInput) firstInput.focus();
  }
}
document.addEventListener('keydown', function(e) {
  if (e.key === "Tab") setModalFocus();
});

// ============================
// EXTENSION POINTS (pour modules futurs)
// ============================

// Placeholder pour des modules complémentaires
// Exemples : synchronisation cloud, gestion avancée des utilisateurs, notifications, etc.

// ============================
// FIN DE APP.JS
// ============================
    // ============================
// EXTENSIONS, MODULES FUTURS, ETC.
// ============================

// Synchronisation cloud (exemple de point d'extension)
function syncCloud() {
  // Placeholder pour synchronisation
  showQuick("Synchronisation à venir...", "var(--muted)");
}

// Notifications (exemple)
function notifyUser(message, type = "info") {
  // Placeholder pour notification système
  alert(`[${type.toUpperCase()}] ${message}`);
}

// Gestion utilisateurs avancée (exemple)
function userLogin(username, password) {
  // Placeholder pour authentification
  showQuick("Authentification à venir...", "var(--muted)");
  return false;
}

// Gestion des préférences utilisateur
function setPreference(prefKey, value) {
  localStorage.setItem('pref_' + prefKey, JSON.stringify(value));
}
function getPreference(prefKey, defaultValue) {
  const val = localStorage.getItem('pref_' + prefKey);
  return val ? JSON.parse(val) : defaultValue;
}

// Mode sombre / clair
function toggleTheme() {
  const current = getPreference('theme', 'dark');
  const next = current === 'dark' ? 'light' : 'dark';
  document.body.setAttribute('data-theme', next);
  setPreference('theme', next);
  showQuick(`Thème ${next} activé !`);
}

// Ecouteur pour raccourci clavier thème
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.key === 't') {
    toggleTheme();
  }
});

// ============================
// GESTION DU SERVICE WORKER (pour PWA)
// ============================
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then(function(reg) {
    showQuick("Service Worker enregistré pour PWA.");
  }).catch(function(err) {
    showQuick("Erreur Service Worker", "var(--danger)");
  });
}

// ============================
// MODULES SUPPLÉMENTAIRES (à ajouter)
// ============================
// Placeholder pour tout module JS additionnel (ex: analyse, export PDF, reporting, etc.)

// ============================
// FIN DU FICHIER JS
// ============================
// ============================
// MODULES ADDITIONNELS / POINTS D'EXTENSION
// ============================

// Exemple : Export PDF (placeholder)
function exportPDF() {
  showQuick("Fonction export PDF à venir...", "var(--muted)");
}

// Exemple : Reporting avancé (placeholder)
function showReport() {
  openModal("<h2>Reporting avancé</h2><div>Module à développer...</div>");
}

// Exemple : Synchronisation multi-device (placeholder)
function syncMultiDevice() {
  showQuick("Sync multi-device à venir...", "var(--muted)");
}

// Exemple : Ajout d'un module de notifications natives
function requestNotificationPermission() {
  if ("Notification" in window) {
    Notification.requestPermission().then(function(permission) {
      showQuick("Permission notification : " + permission);
    });
  } else {
    showQuick("Notifications non supportées", "var(--danger)");
  }
}

// Exemple : Envoi d'une notification
function sendNotification(title, body) {
  if ("Notification" in window && Notification.permission === "granted") {
    new Notification(title, { body });
  }
}

// Appel automatique sur certains événements (exemple)
function notifyOnWeekChange() {
  sendNotification("Semaine changée", "Vous êtes maintenant sur la semaine " + state.week + "!");
}

// Ajout d'un écouteur pour notifier lors du changement de semaine
document.getElementById('nextWeek').addEventListener('click', notifyOnWeekChange);
document.getElementById('prevWeek').addEventListener('click', notifyOnWeekChange);

// ============================
// OUTILS POUR DEVELOPPEURS
// ============================

// Debug : Afficher l'état complet
function debugShowState() {
  openModal(`<h2>État complet</h2><pre>${JSON.stringify(state, null, 2)}</pre>`);
}

// Debug rapide : vider le localStorage
function clearAllStorage() {
  localStorage.clear();
  showQuick("LocalStorage vidé !");
}

// Ajout d'un bouton debug sur la page pour les développeurs (optionnel)
const debugBtn = document.createElement('button');
debugBtn.textContent = "Debug État";
debugBtn.className = "btn";
debugBtn.style.position = "fixed";
debugBtn.style.bottom = "10px";
debugBtn.style.right = "10px";
debugBtn.style.zIndex = "2000";
debugBtn.onclick = debugShowState;
document.body.appendChild(debugBtn);

// ============================
// FIN DE APP.JS
// ============================
// ============================
// MODULE : CHARTS ET ANALYSES
// ============================

// Générer un graphique de progression (exemple)
function renderProgressionChart() {
  const ctx = document.createElement('canvas');
  ctx.width = 400;
  ctx.height = 200;
  document.getElementById('modalInner').appendChild(ctx);

  // Données de progression (exemple : Dumbbell Press sur 26 semaines)
  const data = [];
  for (let week = 1; week <= 26; week++) {
    data.push(calculerCharge('Dumbbell Press', week));
  }

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: Array.from({ length: 26 }, (_, i) => `S${i+1}`),
      datasets: [{
        label: 'Dumbbell Press (kg)',
        data: data,
        borderColor: 'rgba(245,158,11,0.8)',
        backgroundColor: 'rgba(245,158,11,0.18)',
        fill: true,
        tension: 0.2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true }
      }
    }
  });
}

// Listener sur bouton stat progression
document.getElementById('openStatsHist').onclick = () => {
  openModal('<h2>Progression Dumbbell Press</h2><div id="progressChart"></div>');
  renderProgressionChart();
};

// Générer un graphique de volume musculaire (exemple)
function renderVolumeChart() {
  const ctx = document.createElement('canvas');
  ctx.width = 400;
  ctx.height = 200;
  document.getElementById('modalInner').appendChild(ctx);

  // Données de volume par muscle
  const volumes = calculateExactMuscleVolumes();
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Object.keys(volumes),
      datasets: [{
        label: 'Volume hebdomadaire',
        data: Object.values(volumes),
        backgroundColor: 'rgba(59,130,246,0.7)'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      }
    }
  });
}

// Listener sur bouton volume
document.getElementById('openVolume').onclick = () => {
  openModal('<h2>Volume musculaire hebdomadaire</h2><div id="volumeChart"></div>');
  renderVolumeChart();
};

// ============================
// MODULE : TABLEAU DE BORD MUSCLES
// ============================

function renderMuscleDashboard() {
  const muscles = calculateExactMuscleVolumes();
  let html = '<div class="stats-grid">';
  Object.entries(muscles).forEach(([muscle, volume]) => {
    const range = getOptimalRange(muscle);
    let color = volume < range.min ? 'var(--danger)' :
      (volume > range.max ? 'var(--accent-2)' : 'var(--success)');
    html += `<div class="volume-item">
      <div style="font-weight:800;color:${color}">${muscle}</div>
      <div>Volume : ${volume} séries</div>
      <div>Optimal : ${range.min}-${range.max}</div>
    </div>`;
  });
  html += '</div>';
  openModal('<h2>Analyse des muscles</h2>' + html);
}

document.getElementById('openMuscle').onclick = renderMuscleDashboard;

// ============================
// MODULE : GESTION DE LA HEATMAP PREMIUM (RAFRAICHISSEMENT)
// ============================
window.heatmapPremiumRefresh = heatmapPremiumRefresh;

// ============================
// FIN DE APP.JS
// ============================
// ============================
// MODULES ANALYTIQUES / EXTENSIONS TIERS
// ============================

// Exemple : intégration Google Analytics (placeholder)
function sendAnalyticsEvent(event, params = {}) {
  // À remplacer par le code réel Google Analytics si besoin
  showQuick(`Analytics : ${event}`, "var(--muted)");
}

// Exemple : intégration service tiers (ex: Zapier, webhooks)
function sendWebhook(url, payload) {
  fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  }).then(resp => {
    showQuick("Webhook envoyé !");
  }).catch(err => {
    showQuick("Erreur Webhook", "var(--danger)");
  });
}

// Exemple : personnalisation côté utilisateur
function saveCustomTheme(themeObj) {
  setPreference('customTheme', themeObj);
  document.body.style.background = themeObj.background || '';
  document.body.style.color = themeObj.color || '';
  showQuick("Thème personnalisé appliqué !");
}

// Exemple : import/export thèmes
function exportCustomTheme() {
  const theme = getPreference('customTheme', {});
  openModal(`<h2>Exporter Thème</h2><textarea style="width:100%;height:120px">${JSON.stringify(theme, null, 2)}</textarea>`);
}
function importCustomTheme(json) {
  try {
    const themeObj = JSON.parse(json);
    saveCustomTheme(themeObj);
  } catch (e) {
    showQuick("Erreur import thème", "var(--danger)");
  }
}

// Ajout d'un bouton pour exporter le thème
const exportThemeBtn = document.createElement('button');
exportThemeBtn.textContent = "Exporter Thème";
exportThemeBtn.className = "btn";
exportThemeBtn.style.position = "fixed";
exportThemeBtn.style.bottom = "50px";
exportThemeBtn.style.right = "10px";
exportThemeBtn.style.zIndex = "2000";
exportThemeBtn.onclick = exportCustomTheme;
document.body.appendChild(exportThemeBtn);

// ============================
// MODULES DE TEST / DEVELOPPEMENT
// ============================

// Fonction de test asynchrone
async function runAsyncTest() {
  showQuick("Test asynchrone lancé...");
  await new Promise(resolve => setTimeout(resolve, 1500));
  showQuick("Test asynchrone terminé !");
}

// Ajout d'un bouton pour lancer le test
const asyncTestBtn = document.createElement('button');
asyncTestBtn.textContent = "Test Async";
asyncTestBtn.className = "btn";
asyncTestBtn.style.position = "fixed";
asyncTestBtn.style.bottom = "90px";
asyncTestBtn.style.right = "10px";
asyncTestBtn.style.zIndex = "2000";
asyncTestBtn.onclick = runAsyncTest;
document.body.appendChild(asyncTestBtn);

// ============================
// FIN DE APP.JS
// ============================
// ============================
// INTÉGRATION API EXTERNES / UTILITAIRES DIVERS
// ============================

// Exemple : appel à une API externe (placeholder)
async function callExternalAPI(endpoint, params = {}) {
  try {
    const resp = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(params)
    });
    if (!resp.ok) throw new Error("Erreur API");
    const data = await resp.json();
    showQuick("API externe : succès !");
    return data;
  } catch (e) {
    showQuick("Erreur API externe", "var(--danger)");
    return null;
  }
}

// Exemple : récupération d'une ressource distante
function fetchResource(url) {
  fetch(url)
    .then(resp => resp.text())
    .then(text => {
      openModal(`<h2>Ressource distante</h2><pre>${text}</pre>`);
    })
    .catch(() => showQuick("Erreur ressource", "var(--danger)"));
}

// Exemple : module de personnalisation avancée
function applyUserSettings(settings) {
  Object.entries(settings).forEach(([k,v])=>{
    document.body.style[k] = v;
  });
  showQuick("Paramètres utilisateur appliqués !");
}

// Module : gestion du cache local
function setCache(key, value) {
  try { localStorage.setItem('cache_' + key, JSON.stringify(value)); } catch(e){}
}
function getCache(key, defaultValue = null) {
  try {
    const val = localStorage.getItem('cache_' + key);
    return val ? JSON.parse(val) : defaultValue;
  } catch(e){ return defaultValue; }
}
function clearCache(key) {
  try { localStorage.removeItem('cache_' + key); } catch(e){}
}

// Module : gestion de la date/heure utilisateur
function getUserDate() {
  return new Date().toLocaleString();
}

// Module : affichage rapide d'une info (snackbar)
function showSnackbar(msg) {
  const bar = document.createElement('div');
  bar.textContent = msg;
  bar.style.position = 'fixed';
  bar.style.bottom = '20px';
  bar.style.left = '50%';
  bar.style.transform = 'translateX(-50%)';
  bar.style.background = 'var(--accent)';
  bar.style.color = '#080b12';
  bar.style.padding = '10px 18px';
  bar.style.borderRadius = '10px';
  bar.style.zIndex = '9999';
  document.body.appendChild(bar);
  setTimeout(()=>bar.remove(), 2500);
}

// ============================
// MODULES POUR EXTENSIONS FUTURES
// ============================

// Placeholder pour des modules futurs (ex : synchronisation Bluetooth, gestion API mobile, etc.)

// ============================
// FIN DE APP.JS
// ============================
// ============================
// LOGS, HOOKS ET SURVEILLANCE
// ============================

// Logger centralisé
function logEvent(type, message, details = {}) {
  const logLine = `[${new Date().toISOString()}] [${type}] ${message} ${Object.keys(details).length ? JSON.stringify(details) : ''}`;
  if (window.console && typeof console.log === 'function') console.log(logLine);
  setCache('lastLog', logLine);
}

// Hook personnalisable avant chaque action majeure (exemple)
function preActionHook(actionName, params = {}) {
  logEvent('HOOK', `Pré-action : ${actionName}`, params);
  // Extension : tu peux ajouter ici des checks, des prompts, etc.
}

// Hook personnalisable après chaque action majeure (exemple)
function postActionHook(actionName, result) {
  logEvent('HOOK', `Post-action : ${actionName}`, { result });
  // Extension : tu peux ajouter ici des callbacks, des triggers, etc.
}

// Gestion d’erreur centralisée
function handleError(error, context = '') {
  logEvent('ERROR', `Erreur : ${error.message || error}`, { context });
  showQuick("Erreur détectée : " + (error.message || error), "var(--danger)");
}

// Audit : stocker l’historique des actions
function auditAction(action, details={}) {
  let audit = getCache('auditLog', []);
  audit.push({time:new Date().toISOString(),action,details});
  setCache('auditLog', audit);
}

// Afficher l’audit dans un modal
function showAuditLog() {
  const audit = getCache('auditLog', []);
  openModal(`<h2>Audit Log</h2><pre>${JSON.stringify(audit, null, 2)}</pre>`);
}

// Bouton audit sur la page pour développeurs
const auditBtn = document.createElement('button');
auditBtn.textContent = "Audit Log";
auditBtn.className = "btn";
auditBtn.style.position = "fixed";
auditBtn.style.bottom = "130px";
auditBtn.style.right = "10px";
auditBtn.style.zIndex = "2000";
auditBtn.onclick = showAuditLog;
document.body.appendChild(auditBtn);

// ============================
// FIN DE APP.JS
// ============================
// ============================
// INTEGRATION OUTILS TIERS & ENVIRONNEMENT DEV
// ============================

// Intégration GitHub Copilot (placeholder)
function copilotSuggest(codeContext) {
  showQuick("Suggestion Copilot à venir...", "var(--muted)");
  // Placeholder pour une vraie intégration
}

// Intégration d'un éditeur de code embarqué (placeholder)
function openEmbeddedEditor(initialCode = "") {
  openModal(`
    <h2>Éditeur embarqué</h2>
    <textarea style="width:100%;height:320px;">${initialCode}</textarea>
    <button onclick="closeModal()">Fermer</button>
  `);
}

// Automatisation routine hebdomadaire (exemple)
function automateWeeklyRoutine() {
  showQuick("Routine hebdomadaire automatisée !");
  // Exemples de tâches :
  // - Sauvegarde automatique
  // - Exports de données
  // - Envoi email/notification
  // - Synchronisation cloud
  saveState();
  logEvent('INFO', 'Routine hebdomadaire exécutée');
}

// Déclencheur automatique chaque lundi à 9h (exemple)
function scheduleWeeklyAutomation() {
  const now = new Date();
  // Si on est lundi à 9h (heure locale)
  if (now.getDay() === 1 && now.getHours() === 9) {
    automateWeeklyRoutine();
  }
}
setInterval(scheduleWeeklyAutomation, 60 * 1000); // Vérifie chaque minute

// Outil de vérification du support navigateur
function checkBrowserSupport() {
  const features = [
    'fetch' in window,
    'localStorage' in window,
    'serviceWorker' in navigator,
    'Notification' in window
  ];
  if (features.every(Boolean)) {
    showQuick("Navigateur compatible !", "var(--success)");
  } else {
    showQuick("Certaines fonctionnalités manquent", "var(--danger)");
  }
}

// Ajout bouton pour check support navigateur
const browserBtn = document.createElement('button');
browserBtn.textContent = "Check Navigateur";
browserBtn.className = "btn";
browserBtn.style.position = "fixed";
browserBtn.style.bottom = "210px";
browserBtn.style.right = "10px";
browserBtn.style.zIndex = "2000";
browserBtn.onclick = checkBrowserSupport;
document.body.appendChild(browserBtn);

// ============================
// FIN DE APP.JS
// ============================
// ============================
// ENVIRONNEMENT DE TEST, CI/CD, PRODUCTION
// ============================

// Routine de nettoyage avant déploiement
function cleanForDeployment() {
  // Purge des logs de debug
  clearCache('auditLog');
  clearCache('lastLog');
  // Optionnel : suppression des boutons debug
  document.querySelectorAll('button.btn').forEach(btn => {
    if (btn.textContent.startsWith("Debug") ||
        btn.textContent.startsWith("Audit") ||
        btn.textContent.startsWith("Check Santé") ||
        btn.textContent.startsWith("Check Navigateur")) {
      btn.remove();
    }
  });
  showQuick("Nettoyage avant déploiement terminé !");
}

// Routine d’init pour la CI/CD
function initCICDEnv() {
  showQuick("Initialisation CI/CD...");
  // Placeholders pour : 
  // - Préparation des variables d’environnement
  // - Configuration des hooks de build
  // - Préparation des rapports
  logEvent('INFO', 'Environnement CI/CD initialisé');
}

// Routine de test automatique (placeholder)
function runAutomatedTests() {
  showQuick("Tests automatiques en cours...");
  setTimeout(() => {
    showQuick("Tous les tests passés !", "var(--success)");
    logEvent('INFO', 'Automated tests success');
  }, 1200);
}

// Routine de préparation à la production (placeholder)
function prepareForProduction() {
  showQuick("Préparation à la production...");
  cleanForDeployment();
  logEvent('INFO', 'Production ready');
}

// Déclencheur manuel (bouton) pour chaque routine
const prodBtn = document.createElement('button');
prodBtn.textContent = "Prod Ready";
prodBtn.className = "btn";
prodBtn.style.position = "fixed";
prodBtn.style.bottom = "250px";
prodBtn.style.right = "10px";
prodBtn.style.zIndex = "2000";
prodBtn.onclick = prepareForProduction;
document.body.appendChild(prodBtn);

const ciBtn = document.createElement('button');
ciBtn.textContent = "CI/CD Init";
ciBtn.className = "btn";
ciBtn.style.position = "fixed";
ciBtn.style.bottom = "290px";
ciBtn.style.right = "10px";
ciBtn.style.zIndex = "2000";
ciBtn.onclick = initCICDEnv;
document.body.appendChild(ciBtn);

const testBtn = document.createElement('button');
testBtn.textContent = "Tests Auto";
testBtn.className = "btn";
testBtn.style.position = "fixed";
testBtn.style.bottom = "330px";
testBtn.style.right = "10px";
testBtn.style.zIndex = "2000";
testBtn.onclick = runAutomatedTests;
document.body.appendChild(testBtn);

// ============================
// FIN DE APP.JS
// ============================
// ============================
// MIGRATION DE DONNÉES, COMPATIBILITÉ, EXTENSIONS FUTURES
// ============================

// Fonction de migration de structure d’état (exemple)
function migrateStateIfNeeded() {
  // Ajoute une nouvelle clé si absente
  if (!state.customExercises) {
    state.customExercises = [];
    logEvent('MIGRATION', 'Ajout de customExercises[]');
  }
  // Migration d’un format d’historique
  if (state.hist && typeof state.hist === 'object') {
    Object.keys(state.hist).forEach(key => {
      state.hist[key] = state.hist[key].map(entry => {
        if (!entry.hasOwnProperty('week')) {
          entry.week = 1; // Valeur par défaut si absente
        }
        return entry;
      });
    });
    logEvent('MIGRATION', 'Upgrade format hist');
  }
  saveState();
  showQuick("Migration d’état terminée !");
}

// Bouton pour lancer la migration
const migrateBtn = document.createElement('button');
migrateBtn.textContent = "Migrer État";
migrateBtn.className = "btn";
migrateBtn.style.position = "fixed";
migrateBtn.style.bottom = "530px";
migrateBtn.style.right = "10px";
migrateBtn.style.zIndex = "2000";
migrateBtn.onclick = migrateStateIfNeeded;
document.body.appendChild(migrateBtn);

// Extension future : compatibilité multi-plateformes (placeholder)
function prepareForMultiPlatform() {
  showQuick("Préparation multi-plateforme à venir...", "var(--muted)");
  // Ici, routines d’adaptation pour mobile, desktop, PWA, etc.
}

// Bouton pour compatibilité multi-plateformes
const multiPlatformBtn = document.createElement('button');
multiPlatformBtn.textContent = "Multi-plateformes";
multiPlatformBtn.className = "btn";
multiPlatformBtn.style.position = "fixed";
multiPlatformBtn.style.bottom = "570px";
multiPlatformBtn.style.right = "10px";
multiPlatformBtn.style.zIndex = "2000";
multiPlatformBtn.onclick = prepareForMultiPlatform;
document.body.appendChild(multiPlatformBtn);

// Extension future : upgrade de version du programme
function upgradeProgramVersion() {
  showQuick("Upgrade version programme à venir...", "var(--muted)");
  // Ici tu pourrais gérer des migrations de structure de données, conversion, etc.
}

// Bouton pour upgrade version
const upgradeBtn = document.createElement('button');
upgradeBtn.textContent = "Upgrade Version";
upgradeBtn.className = "btn";
upgradeBtn.style.position = "fixed";
upgradeBtn.style.bottom = "610px";
upgradeBtn.style.right = "10
// ============================
// EVOLUTION DU PROGRAMME, EXTENSIONS FINALES
// ============================

// Upgrade de version du programme (suite du bouton précédent)
upgradeBtn.style.position = "fixed";
upgradeBtn.style.bottom = "610px";
upgradeBtn.style.right = "10px";
upgradeBtn.style.zIndex = "2000";
upgradeBtn.onclick = upgradeProgramVersion;
document.body.appendChild(upgradeBtn);

// Extension finale : routine d’auto-évolution du code (placeholder)
function autoEvolveProgram() {
  showQuick("Routine auto-évolution à venir...", "var(--muted)");
  // Place ici des scripts de migration, transformation automatique, adaptation IA, etc.
}

// Bouton pour auto-évolution
const evolveBtn = document.createElement('button');
evolveBtn.textContent = "Auto-Évolution";
evolveBtn.className = "btn";
evolveBtn.style.position = "fixed";
evolveBtn.style.bottom = "650px";
evolveBtn.style.right = "10px";
evolveBtn.style.zIndex = "2000";
evolveBtn.onclick = autoEvolveProgram;
document.body.appendChild(evolveBtn);

// Extension future : support de plugins externes (placeholder)
function installExternalPlugin(pluginName) {
  showQuick(`Installation du plugin ${pluginName} à venir...`, "var(--muted)");
  // Place ici la logique d'installation, vérification, etc.
}

// ============================
// FIN ABSOLUE DE APP.JS
// ============================




